<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="org.conan.mapper.RecipeMapper">

	<select id="readRecipe" resultType="org.conan.domain.RecipeVO">select * from
		t_recipe where
		rid=#{rid}
	</select>

	<select id="readIngre" resultType="org.conan.domain.IngreVO">select * from 
		t_ingre where
		rid=#{rid}
	</select>

	<select id="readProce" resultType="org.conan.domain.ProceVO">select * from 
		t_proce where
		rid=#{rid}
	</select>

	<select id="readAllIngreNames" resultType="String">select ingre_name from
		t_ingre
	</select>

	<select id="readIngreNames" resultType="String">select ingre_name from
		t_ingrewhere rid = #{rid}
	</select>

	<select id="recipeCount" resultType="int">select count(rid) from
		t_recipe
	</select>

	<select id="getList" resultType="org.conan.domain.RecipeVO">select * from t_recipe </select>



	<insert id="recipeinsert">

		<selectKey resultType="int" order="BEFORE" keyProperty="rid">selectr_seq.nextval
			from dual
		</selectKey>
		insert into t_recipe(rid, name, img,summary) values (#{rid},
		#{name},#{img}, #{summary})
	</insert>

	<insert id="ingreinsert">insert into t_ingrevalues((select max(rid)
		fromt_recipe),#{ingre_name},#{ingre_count},#{ingre_unit})
	</insert>

	<insert id="proceinsert">insert into t_procevalues((select max(rid)
		fromt_recipe),#{txt},#{pimg})
	</insert>



	<select id="getListWithPaging"
		resultType="org.conan.domain.RecipeVO">

		<![CDATA[select * from(
select /*+INDEX_DESC(t_recipe pk_recipe)*/
rownum rn,rid,name,img,summary
from t_recipe
where]]>
		<!-- <include refid='criteria'></include> -->


		<![CDATA[ rownum <=#{pageNum}*#{amount}
)
where rn>(#{pageNum}-1)*#{amount}]]>
	</select>

	<insert id="insertRecipe">insert into t_recipe(rid, name,
		img,summary)values(2000, #{name}, #{img}, #{summary})
	</insert>

	<select id="b_getList" resultType="org.conan.domain.BoardVO">select * from tbl_board
		wherebno>0
	</select>

	<!-- 인설트 문에 ? 대신에 #{변수이름(대소문자 구분함, 자바필드이기때문)}, 넣으면 setString등 사용X -->


	<insert id="insert">insert into tbl_board(bno, title, content,
		writer)values(seq_board.nextval, #{title},#{content},#{writer})
	</insert>

	<update id="updateReplyCnt">update tbl_boardset replycnt =
		replycnt+#{amount}where bno =#{bno}
	</update>


	<insert id="insertSelectKey">
		<selectKey resultType="long" order="BEFORE"
			keyProperty="bno">select seq_board.nextval from dual
		</selectKey>
		insert into tbl_board(bno, title, content, writer)
		values(#{bno},#{title}, #{content}, #{writer})
	</insert>

	<select id="read" resultType="org.conan.domain.BoardVO">select * from tbl_board
		wherebno=${bno}
	</select>

	<delete id="delete">delete from tbl_board where bno=#{bno} </delete>

	<update id="update">update tbl_board set
		title=#{title},content=#{content}, updateDate=sysdate where bno=#{bno}
	</update>



	<sql id="criteria">



		<trim prefixOverrides="OR" suffix=")AND" prefix="(">



			<foreach collection="typeArr" item="type">



				<trim prefix="OR">



					<choose>

						<when test="type=='T'.toString()">title like '%'||#{keyword}||'%'</when>

						<when test="type=='C'.toString()">content like '%'||#{keyword}||'%'</when>

						<when test="type=='W'.toString()">writer like '%'||#{keyword}||'%'</when>

					</choose>

				</trim>

			</foreach>

		</trim>

	</sql>



	<select id="b_getListWithPaging"
		resultType="org.conan.domain.BoardVO">

		<![CDATA[select * from(
select /*+INDEX_DESC(tbl_board pk_board)*/
rownum rn,bno,title,content,writer,regdate,updateDate,replyCnt
from tbl_board
where]]>
		<include refid="criteria" />

		<![CDATA[ rownum <=#{pageNum}*#{amount}
)
where rn>(#{pageNum}-1)*#{amount}]]>
	</select>



	<select id="b_getTotalCount" resultType="int">
		select count(*) fromtbl_boardwhere
		<include refid="criteria" />
		bno>0
	</select>
	
	
<select id="readBestRecipe" resultType="org.conan.domain.RecipeVO">
select tr.rid, tr.name, tr.likecount,tr.img from (select rid,name,likecount,img from t_recipe order by likecount desc) tr where rownum 
<![CDATA[ < ]]>=20 
</select>


<select id="readMinIngRecipe" resultType="org.conan.domain.RecipeVO">
select a.rid, a.ingcount, a.name, a.img from (select r.rid, i.ingcount, r.name, r.img, r.summary from (select rid, count(rid) ingcount from t_ingre group by rid) i,t_recipe r where r.rid = i.rid order by i.ingcount) a where rid !=135 and rownum
<![CDATA[ < ]]>=20 
</select>



	<select id="readBestRecipe"
		resultType="org.conan.domain.RecipeVO">
		select tr.rid, tr.name, tr.likecount,tr.img from (select
		rid,name,likecount,img from t_recipe order by likecount desc) tr where
		rownum
		<![CDATA[ < ]]>=20
	</select>



	<select id="readMinIngRecipe"
		resultType="org.conan.domain.RecipeVO">
		select a.rid, a.ingcount, a.name, a.img from (select r.rid,
		i.ingcount, r.name, r.img, r.summary from (select rid, count(rid)
		ingcount from t_ingre group by rid) i,t_recipe r where r.rid = i.rid
		order by i.ingcount) a where rid !=135 and rownum
		<![CDATA[ < ]]>=20
	</select>

</mapper>